# from twilio.rest import Client
import time
import json
from datetime import datetime

from wild_log   import Log
from MqttClient import MqttClient

"""
msg_train_consolidated_info = {"dpu_id": "DPU_01",
                               "train_id": "T20210912032753",
                               "train_entry_time": 1631397470.453871,
                               "train_exit_time": 1631397501.051174,
                               "total_axles": 70, "total_wheels": 140,
                               "total_bad_wheels": 2,
                               "direction": "DBU->YNK",
                               "train_speed": 77.51,
                               "ilf_threshold_warning": 2.0,
                               "ilf_threshold_critical": 4.5
                               }

msg_train_processed_info = {"train_id": "T20210912032753",
                            "dpu_id": "DPU_01",
                            "ts": 1631397501.051174,
                            "axle_id": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70],
                            "axle_speed": [86.39, 86.39, 86.28, 86.44, 86.05, 86.22, 85.42, 86.07, 85.51, 85.67, 85.37, 85.31, 85.08, 85.02, 84.7, 84.64, 84.05, 84.19, 84.06, 83.89, 83.17, 83.57, 82.75, 82.76, 82.35, 82.25, 81.73, 81.94, 80.94, 80.98, 80.69, 80.59, 79.73, 79.72, 79.27, 79.2, 78.32, 78.27, 77.66, 77.81, 76.83, 76.73, 76.26, 76.32, 75.14, 75.11, 74.89, 74.43, 73.46, 73.2, 72.62, 72.72, 71.51, 71.28, 70.6, 70.45, 69.34, 69.11, 68.58, 68.33, 67.14, 66.89, 66.36, 66.11, 64.8, 64.61, 63.87, 63.7, 62.42, 62.23],
                            "avg_dyn_load_left": [11.01, 10.54, 10.83, 10.93, 9.25, 9.75, 8.93, 8.93, 8.55, 8.34, 7.55, 7.23, 7.56, 7.1, 8.37, 8.2, 7.09, 7.29, 7.57, 7.47, 7.21, 6.95, 7.74, 7.1, 7.96, 7.65, 8.28, 7.81, 7.86, 7.35, 7.8, 7.42, 7.63, 7.33, 6.59, 6.08, 7.8, 7.64, 7.68, 7.4, 7.65, 6.36, 7.93, 7.5, 7.3, 7.02, 7.22, 6.93, 7.82, 7.53, 7.04, 6.63, 7.58, 7.19, 8.42, 7.46, 6.18, 5.78, 7.25, 6.8, 7.63, 7.5, 7.98, 7.21, 7.36, 7.06, 7.64, 7.29, 6.3, 6.21],
                            "avg_dyn_load_right": [9.93, 8.59, 10.08, 10.4, 9.21, 10.46, 8.54, 8.19, 8.85, 7.75, 7.1, 6.67, 6.91, 6.71, 6.65, 6.19, 7.78, 7.05, 6.85, 6.19, 6.63, 6.04, 7.42, 6.83, 6.48, 6.11, 7.14, 6.83, 6.83, 6.43, 7.28, 6.93, 6.94, 6.39, 8.26, 8.03, 6.5, 6.04, 7.12, 6.77, 7.49, 7.37, 6.55, 6.72, 6.73, 6.55, 7.62, 7.22, 6.71, 6.48, 7.31, 6.66, 6.98, 6.18, 6.54, 6.52, 7.66, 7.31, 7.34, 6.53, 6.7, 6.0, 7.32, 6.99, 7.46, 6.88, 7.21, 6.47, 6.35, 5.65],
                            "max_dyn_load_left": [14.79, 13.97, 13.23, 15.0, 12.0, 13.99, 21.44, 15.08, 10.88, 11.64, 10.61, 10.02, 9.78, 9.01, 10.43, 10.31, 8.88, 9.41, 9.51, 9.6, 9.52, 9.21, 9.59, 9.07, 9.68, 15.58, 9.88, 9.94, 9.22, 9.82, 9.68, 9.49, 9.32, 10.19, 8.38, 7.62, 9.56, 9.32, 10.0, 10.86, 9.72, 8.87, 10.08, 9.91, 9.46, 8.97, 18.74, 11.2, 9.68, 12.76, 8.4, 8.25, 9.45, 9.05, 10.18, 8.82, 7.81, 7.25, 8.89, 8.12, 9.16, 9.54, 9.88, 9.28, 9.08, 8.65, 9.02, 8.94, 7.36, 7.34],
                            "max_dyn_load_right": [13.75, 10.76, 12.64, 15.08, 11.52, 14.15, 20.22, 19.13, 12.69, 11.27, 9.52, 11.34, 13.57, 10.41, 9.62, 9.95, 10.03, 8.98, 9.6, 8.49, 13.49, 8.82, 9.88, 10.41, 10.25, 10.01, 9.01, 8.78, 10.32, 10.48, 10.71, 9.24, 10.45, 8.46, 10.7, 10.73, 8.46, 9.0, 12.89, 9.37, 12.35, 11.2, 9.96, 10.02, 9.13, 8.27, 9.62, 13.8, 8.96, 11.75, 10.53, 14.0, 9.15, 8.57, 8.31, 8.3, 9.68, 9.29, 9.02, 8.49, 9.12, 8.51, 9.22, 8.68, 9.22, 8.24, 10.12, 8.59, 8.05, 7.24],
                            "vertical_load_left": [14.79, 13.97, 13.23, 15.0, 12.0, 13.99, 21.44, 15.08, 10.88, 11.64, 10.61, 10.02, 9.78, 9.01, 10.43, 10.31, 8.88, 9.41, 9.51, 9.6, 9.52, 9.21, 9.59, 9.07, 9.68, 15.58, 9.88, 9.94, 9.22, 9.82, 9.68, 9.49, 9.32, 10.19, 8.38, 7.62, 9.56, 9.32, 10.0, 10.86, 9.72, 8.87, 10.08, 9.91, 9.46, 8.97, 18.74, 11.2, 9.68, 12.76, 8.4, 8.25, 9.45, 9.05, 10.18, 8.82, 7.81, 7.25, 8.89, 8.12, 9.16, 9.54, 9.88, 9.28, 9.08, 8.65, 9.02, 8.94, 7.36, 7.34],
                            "vertical_load_right": [13.75, 10.76, 12.64, 15.08, 11.52, 14.15, 20.22, 19.13, 12.69, 11.27, 9.52, 11.34, 13.57, 10.41, 9.62, 9.95, 10.03, 8.98, 9.6, 8.49, 13.49, 8.82, 9.88, 10.41, 10.25, 10.01, 9.01, 8.78, 10.32, 10.48, 10.71, 9.24, 10.45, 8.46, 10.7, 10.73, 8.46, 9.0, 12.89, 9.37, 12.35, 11.2, 9.96, 10.02, 9.13, 8.27, 9.62, 13.8, 8.96, 11.75, 10.53, 14.0, 9.15, 8.57, 8.31, 8.3, 9.68, 9.29, 9.02, 8.49, 9.12, 8.51, 9.22, 8.68, 9.22, 8.24, 10.12, 8.59, 8.05, 7.24],
                            "lateral_load_left": [0.83, 4.45, 0.88, 1.36, 4.49, 3.29, 0.42, 1.67, 0.74, 1.11, 1.5, 0.42, 0.88, 0.46, 1.1, 0.46, 0.72, 0.56, 1.38, 0.22, 1.05, 0.44, 0.83, 0.37, 0.58, 1.36, 3.26, 2.75, 0.74, 0.3, 1.2, 0.23, 0.62, 0.21, 1.05, 0.61, 1.06, 0.39, 1.11, 0.98, 1.02, 0.94, 1.26, 0.6, 0.93, 0.47, 2.54, 0.52, 1.22, 0.22, 1.11, 0.4, 1.38, 0.49, 1.46, 0.73, 0.84, 0.2, 1.18, 0.31, 0.78, 0.3, 0.77, 0.47, 0.78, 0.3, 1.05, 1.54, 0.29, 0.98],
                            "lateral_load_right": [3.12, 1.08, 3.61, 4.55, 2.36, 2.67, 0.97, 4.1, 1.95, 1.68, 2.15, 1.95, 2.07, 1.77, 1.5, 1.73, 1.75, 1.76, 1.35, 1.45, 1.46, 1.65, 1.27, 0.45, 0.65, 0.27, 0.92, 0.63, 1.46, 1.57, 1.66, 1.86, 1.44, 1.74, 2.37, 1.73, 1.82, 1.98, 1.11, 2.16, 1.9, 2.49, 1.92, 1.47, 0.93, 2.01, 2.28, 2.1, 1.66, 1.84, 2.57, 4.33, 2.01, 2.04, 1.95, 1.43, 2.5, 1.62, 1.97, 1.42, 1.34, 1.24, 1.93, 1.41, 1.95, 1.88, 1.67, 1.19, 2.21, 1.7],
                            "ilf_left": [1.34, 1.33, 1.22, 1.37, 1.3, 1.43, 2.4, 1.69, 1.27, 1.4, 1.41, 1.39, 1.29, 1.27, 1.25, 1.26, 1.25, 1.29, 1.26, 1.29, 1.32, 1.33, 1.24, 1.28, 1.22, 2.04, 1.19, 1.27, 1.17, 1.34, 1.24, 1.28, 1.22, 1.39, 1.27, 1.25, 1.23, 1.22, 1.3, 1.47, 1.27, 1.4, 1.27, 1.32, 1.3, 1.28, 2.6, 1.62, 1.24, 1.69, 1.19, 1.24, 1.25, 1.26, 1.21, 1.18, 1.26, 1.25, 1.23, 1.19, 1.2, 1.27, 1.24, 1.29, 1.23, 1.23, 1.18, 1.23, 1.17, 1.18],
                            "ilf_right": [1.38, 1.25, 1.25, 1.45, 1.25, 1.35, 2.37, 2.34, 1.43, 1.45, 1.34, 1.7, 1.96, 1.55, 1.45, 1.61, 1.29, 1.27, 1.4, 1.37, 2.03, 1.46, 1.33, 1.52, 1.58, 1.64, 1.26, 1.28, 1.51, 1.63, 1.47, 1.33, 1.51, 1.32, 1.3, 1.34, 1.3, 1.49, 1.81, 1.38, 1.65, 1.52, 1.52, 1.49, 1.36, 1.26, 1.26, 1.91, 1.34, 1.81, 1.44, 2.1, 1.31, 1.39, 1.27, 1.27, 1.26, 1.27, 1.23, 1.3, 1.36, 1.42, 1.26, 1.24, 1.24, 1.2, 1.4, 1.33, 1.27, 1.28],
                            "wheel_status_left": [1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                            "wheel_status_right": [1, 1, 1, 1, 1, 1, 1, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                            "v1_fft_max_freq": [341, 0, 346, 336, 336, 336, 341, 336, 336, 332, 341, 351, 346, 327, 0, 346, 322, 375, 356, 0, 0, 327, 0, 0, 336, 332, 317, 0, 0, 0, 375, 0, 361, 0, 385, 0, 385, 415, 415, 346, 351, 356, 366, 415, 0, 0, 341, 361, 468, 336, 0, 390, 415, 385, 385, 405, 429, 0, 395, 385, 0, 356, 400, 371, 419, 390, 429, 390, 0, 0],
                            "v1_fft_sd": [1397.62, 246.86, 937.59, 2690.89, 1088.52, 1384.82, 1739.6, 2295.97, 1598.18, 367.3, 471.73, 419.72, 394.42, 341.82, 250.23, 422.3, 370.78, 256.01, 332.65, 303.11, 475.85, 893.87, 389.94, 400.11, 660.82, 1526.51, 793.57, 421.5, 364.01, 353.69, 356.81, 345.97, 210.78, 195.33, 198.14, 171.72, 194.1, 172.37, 263.58, 758.08, 357.99, 280.35, 277.73, 180.77, 258.78, 260.36, 1616.59, 308.29, 172.53, 463.2, 210.7, 425.85, 210.71, 309.05, 283.13, 209.94, 292.85, 237.99, 299.96, 294.89, 296.45, 375.25, 280.85, 257.39, 279.65, 222.71, 208.54, 182.13, 272.39, 284.3],
                            "v2_fft_max_freq": [991, 903, 932, 0, 0, 0, 947, 63, 0, 0, 0, 952, 927, 0, 0, 908, 878, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1015, 961, 1040, 908, 0, 0, 0, 0, 0, 0, 0, 0, 0, 981, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                            "v2_fft_sd": [525.66, 171.96, 309.16, 272.73, 270.93, 355.98, 638.65, 401.44, 218.8, 209.22, 171.96, 317.95, 123.47, 104.53, 181.52, 350.18, 193.91, 113.96, 220.21, 261.41, 710.86, 484.98, 331.03, 318.49, 288.16, 349.09, 407.15, 441.85, 272.23, 341.07, 361.91, 414.09, 208.63, 218.05, 221.29, 215.57, 222.07, 159.34, 580.17, 464.0, 186.44, 401.62, 272.54, 263.79, 378.57, 442.72, 632.75, 650.89, 520.36, 535.2, 559.93, 893.13, 655.65, 522.35, 447.61, 490.43, 743.19, 746.41, 565.02, 452.12, 199.17, 223.7, 395.56, 440.78, 430.05, 443.58, 590.99, 576.52, 451.36, 405.07],
                            "v3_fft_max_freq": [1074, 1250, 1240, 258, 1132, 253, 1083, 1142, 1162, 1074, 1040, 1079, 1157, 1196, 1186, 1015, 1103, 1176, 1098, 0, 1083, 0, 1064, 1083, 0, 1049, 0, 0, 1103, 1113, 1152, 1142, 1166, 1162, 1181, 991, 1220, 1108, 1127, 1230, 1108, 258, 1142, 1142, 1103, 0, 0, 0, 0, 214, 1210, 1113, 0, 263, 0, 0, 0, 0, 0, 0, 1166, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                            "v3_fft_sd": [943.25, 493.57, 563.42, 625.49, 452.99, 598.91, 1227.73, 855.9, 848.1, 593.59, 732.38, 963.42, 698.39, 554.5, 540.17, 625.16, 683.0, 555.08, 713.98, 569.82, 771.09, 515.32, 722.3, 671.68, 568.9, 568.97, 493.03, 487.63, 648.25, 589.91, 521.09, 481.65, 578.07, 590.37, 627.63, 614.77, 557.6, 616.94, 388.04, 603.57, 457.97, 453.73, 579.11, 527.32, 505.69, 500.67, 619.08, 674.4, 614.6, 752.55, 645.71, 649.14, 564.82, 436.85, 555.77, 605.75, 738.07, 719.58, 646.78, 653.82, 371.44, 414.27, 614.17, 615.02, 628.91, 628.36, 632.99, 652.36, 491.13, 492.66],
                            "v4_fft_max_freq": [512, 522, 517, 517, 522, 502, 507, 512, 517, 507, 512, 527, 517, 512, 527, 527, 517, 522, 507, 517, 517, 517, 512, 507, 498, 517, 517, 522, 527, 537, 517, 512, 517, 517, 517, 522, 517, 517, 527, 517, 512, 517, 512, 512, 517, 517, 517, 502, 517, 522, 512, 512, 498, 507, 527, 522, 507, 532, 517, 517, 522, 517, 522, 517, 517, 512, 512, 522, 512, 512],
                            "v4_fft_sd": [5048.11, 3446.66, 3310.39, 3553.53, 1955.26, 1477.9, 9386.89, 3366.16, 2554.06, 1758.32, 3064.24, 2741.47, 3376.96, 3765.6, 2972.32, 3634.42, 2586.01, 3645.02, 2822.09, 2218.16, 1531.1, 3265.01, 2424.54, 1422.62, 1567.9, 4146.2, 2202.65, 2408.76, 2011.39, 1769.2, 4388.98, 2218.19, 3273.5, 1973.74, 2365.28, 2232.5, 2044.89, 2269.66, 3211.88, 2955.22, 2334.6, 3453.72, 2166.43, 2492.45, 1654.96, 2063.49, 1977.87, 1707.17, 3016.34, 5252.7, 4630.58, 5009.74, 1899.77, 2459.29, 969.54, 1830.07, 1014.86, 2340.17, 1362.97, 2320.42, 2071.02, 2273.12, 2544.7, 2324.19, 3568.01, 3347.94, 3581.37, 4638.6, 1960.72, 2547.29]
                            }

if __name__ == "__main__":
    if Log.logger is None:
        Log('PM')
    # end-if

    # from subprocess import call
    #
    # call(["powershell", "-command", "(gcim Win32_OperatingSystem).LastBootUpTime"])

    Log.logger.warning(f'START OF PM SIMULATOR : {datetime.now()}')
    # tpi_topic = "site_03/dpu_03/train_processed_info"
    # tci_topic = "site_03/dpu_03/train_consolidated_info"
    tpi_topic = "dpu_pm/train_processed_info"
    tci_topic = "dpu_pm/train_consolidated_info"

    # Create an object for MQTT Client and connect to the broker
    mqtt_clobj = MqttClient("127.0.0.1", 1883, 'CM_Simulator', '', '', 'CM_Simulator')
    mqtt_clobj.connect()

    Log.logger.warning(f'Sending      = {tci_topic}')
    Log.logger.warning(f'--------------------------------------------------')
    json_msg = json.dumps(msg_train_consolidated_info)
    Log.logger.warning(json_msg)

    mqtt_clobj.pub(tci_topic, json_msg)
    time.sleep(5)

    Log.logger.warning(f'Sending      = {tpi_topic}')
    Log.logger.warning(f'--------------------------------------------------')
    json_msg = json.dumps(msg_train_processed_info)
    Log.logger.warning(json_msg)

    mqtt_clobj.pub(tpi_topic, json_msg)
    time.sleep(5)

    Log.logger.warning(f'END  OF CM SIMULATOR : {datetime.now()}')
